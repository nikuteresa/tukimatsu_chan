# 月末くん アーキテクチャ説明

## 1. 全体構成

月末くんは、以下の2つの主要コンポーネントに分かれています：

1. **月末判定コンポーネント** - 今日が月末の最終営業日かどうかを判定する
2. **通知コンポーネント** - 月末判定が真の場合にメール通知を送信する

この2つのコンポーネントは完全に分離されており、独立して使用することも、組み合わせて使用することも可能です。

## 2. コンポーネント詳細

### 2.1 月末判定コンポーネント

- **エントリーポイント**: `bin/determine_month_end.rb`
- **主要クラス**: `MonthEndDeterminer`
- **依存クラス**: `BusinessDayCalculator`, `ConfigManager`
- **出力**: 
  - 環境変数 `IS_LAST_BUSINESS_DAY` (true/false)
  - 環境変数 `YEAR_MONTH` (例: "2025年4月")

このコンポーネントは GitHub Action として定義され、`action.yml` で設定されています。アクションの出力として、月末判定結果と現在の年月情報を提供します。

### 2.2 通知コンポーネント

- **エントリーポイント**: `bin/send_notification.rb`
- **主要クラス**: `NotificationSender`
- **依存クラス**: `Notifier`, `Logger`, `ConfigManager`
- **入力**:
  - 環境変数 `IS_LAST_BUSINESS_DAY` (true/false)
  - 環境変数 `YEAR_MONTH` (例: "2025年4月") (オプション)
- **出力**:
  - 環境変数 `EMAIL_SUBJECT`
  - 環境変数 `EMAIL_BODY`
  - 環境変数 `EMAIL_TO`

このコンポーネントは月末判定結果に基づいて通知を送信します。通知を強制的に送信するには `--force` オプションを使用できます。

## 3. GitHub Actions ワークフロー

GitHub Actions ワークフロー (`monthly_notification.yml`) は以下の構成になっています：

1. **check-month-end ジョブ**:
   - 月末判定アクションを実行
   - 判定結果を次のジョブに受け渡し

2. **send-notification ジョブ**:
   - 月末判定が真の場合のみ実行
   - 通知スクリプトを実行
   - メール送信アクションを実行
   - ログをコミット

## 4. データフロー

```
[月末判定コンポーネント]
      |
      | (IS_LAST_BUSINESS_DAY, YEAR_MONTH)
      v
[通知コンポーネント]
      |
      | (EMAIL_SUBJECT, EMAIL_BODY, EMAIL_TO)
      v
[メール送信アクション]
```

## 5. 拡張性

この分離されたアーキテクチャにより、以下のような拡張が容易になります：

1. **新しい通知チャネルの追加**:
   - Slack通知やLINE通知など、新しい通知メソッドを追加する場合、通知コンポーネントのみを拡張
   - 月末判定ロジックは影響を受けない

2. **判定ロジックの変更**:
   - 営業日の判定ロジックを変更する場合、月末判定コンポーネントのみを変更
   - 通知コンポーネントは影響を受けない

3. **異なる通知タイミングへの対応**:
   - 月初や月中など、他のタイミングでの通知にも同じパターンで対応可能

## 6. テスト戦略

コンポーネントが分離されているため、以下のようなテスト戦略が可能です：

1. **単体テスト**:
   - 月末判定ロジックのテスト
   - 通知生成ロジックのテスト

2. **結合テスト**:
   - 各コンポーネントの統合テスト
   - 環境変数の受け渡しテスト

3. **E2Eテスト**:
   - GitHub Actionsワークフローの全体テスト